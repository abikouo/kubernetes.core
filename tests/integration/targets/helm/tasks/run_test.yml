---
- name: Ensure helm is not installed
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/tmp/helm"

- name: Check failed if helm is not installed
  ansible.builtin.include_tasks: test_helm_not_installed.yml

- name: "Install {{ helm_version }}"
  ansible.builtin.include_role:
    name: install_helm

- name: "Ensure we honor the environment variables"
  ansible.builtin.include_tasks: test_read_envvars.yml

- name: Deploy charts
  ansible.builtin.include_tasks: "tests_chart/{{ test_chart_type }}.yml"
  loop_control:
    loop_var: test_chart_type
  with_items:
    - from_local_path
    - from_repository
    - from_url

- name: Test helm upgrade with reuse_values
  ansible.builtin.include_tasks: test_helm_reuse_values.yml

- name: Test helm dependency update
  ansible.builtin.include_tasks: test_up_dep.yml

- name: Test helm uninstall
  ansible.builtin.include_tasks: test_helm_uninstall.yml

- name: Test helm install with chart name containing space
  ansible.builtin.include_tasks: test_helm_with_space_into_chart_name.yml

# https://github.com/ansible-collections/community.kubernetes/issues/296
- name: Test Skip CRDS feature in helm chart install
  ansible.builtin.include_tasks: test_crds.yml

- name: Clean helm install
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/tmp/helm/"
