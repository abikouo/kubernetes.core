---
- block:
  # It seems that the default ServiceAccount can take a bit to be created
  # right after a cluster is brought up. This can lead to the ServiceAccount
  # admission controller rejecting a Pod creation request because the
  # ServiceAccount does not yet exist.
  - name: Wait for default serviceaccount to be created
    k8s_info:
      kind: ServiceAccount
      name: default
      namespace: "{{ test_namespace }}"
      wait: yes

  - name: list cluster nodes
    k8s_info:
      kind: node
    register: nodes

  - name: Select uncordoned nodes
    set_fact:
      uncordoned_nodes: "{{ nodes.resources | selectattr('spec.unschedulable', 'undefined') | map(attribute='metadata.name') | list}}"

  - name: Assert that at least one node is schedulable
    assert:
      that:
      - uncordoned_nodes | length > 0

  - name: select node to drain
    set_fact:
      node_to_drain: '{{ uncordoned_nodes[0] }}'

  - name: Create resources
    k8s:
      wait: true
      namespace: "{{ test_namespace }}"
      template:
      - daemonset.yml.j2
      - deployment.yml.j2
      - pod1.yml.j2

  - name: Test Cordon node
    ansible.builtin.include_tasks: tasks/cordon.yml

  - name: Test Uncordon node
    ansible.builtin.include_tasks: tasks/uncordon.yml

  - name: Test drain node
    ansible.builtin.include_tasks: tasks/drain.yml

  always:
  - name: Uncordon node
    k8s_drain:
      state: uncordon
      name: '{{ node_to_drain }}'
    when: node_to_drain is defined
    ignore_errors: true

  - name: delete namespace
    k8s:
      state: absent
      kind: namespace
      name: '{{ test_namespace }}'
