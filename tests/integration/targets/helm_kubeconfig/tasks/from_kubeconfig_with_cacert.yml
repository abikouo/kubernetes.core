---
- name: Initialize variables
  ansible.builtin.set_fact:
    content: "{{ lookup('file', default_kubeconfig_path) | from_yaml }}"
    custom_content: {}
    clusters: []

- name: Set custom_content variable
  ansible.builtin.set_fact:
    custom_content: "{{ custom_content | combine({item.key: item.value}) }}"
  when: "{{ item.key not in ['clusters'] }}"
  with_dict: "{{ content }}"

- name: Set clusters variable
  ansible.builtin.set_fact:
    clusters: "{{ clusters + [item | combine({'cluster': {'certificate-authority-data': omit}}, recursive=true)] }}"
  with_items: "{{ content.clusters }}"

- name: Set custom_content variable
  ansible.builtin.set_fact:
    custom_content: "{{ custom_content | combine({'clusters': clusters}) }}"

- name: create temporary file for ca_cert
  ansible.builtin.tempfile:
    suffix: .cacert
  register: ca_file

- name: copy content into certificate file
  ansible.builtin.copy:
    content: "{{ content.clusters.0.cluster['certificate-authority-data'] | b64decode }}"
    dest: "{{ ca_file.path }}"

- name: create temporary file to save config in
  ansible.builtin.tempfile:
    suffix: .config
  register: tfile

- name: create custom config
  ansible.builtin.copy:
    content: "{{ custom_content | to_yaml }}"
    dest: "{{ tfile.path }}"

- name: Run tests
  vars:
    helm_namespace: "{{ test_namespace[1] }}"
  block:
    - name: Install Redis chart without ca_cert (should fail)
      helm:
        binary_path: "{{ helm_binary }}"
        chart_repo_url: https://charts.bitnami.com/bitnami
        chart_ref: redis
        namespace: "{{ helm_namespace }}"
        create_namespace: true
        name: redis-chart
        chart_version: '17.0.5'
        release_values:
          architecture: standalone
        release_state: present
        kubeconfig: "{{ tfile.path }}"
      failed_when: _install is successful
      register: _install

    - name: assert task failed
      ansible.builtin.assert:
        that:
          - _install is failed
          - '"Error: Kubernetes cluster unreachable" in _install.msg'

    - name: Test helm modules using in-memory kubeconfig
      ansible.builtin.include_tasks: "tests_helm_auth.yml"
      vars:
        test_kubeconfig: "{{ tfile.path }}"
        test_ca_cert: "{{ ca_file.path }}"

  always:
    - name: Delete temporary file
      ansible.builtin.file:
        state: absent
        path: "{{ tfile.path }}"
      failed_when: false
