---
- name: "Ensure test_helm_repo doesn't exist"
  kubernetes.core.helm_repository:
    binary_path: "{{ helm_binary }}"
    name: test_helm_repo
    state: absent

- name: Add test_helm_repo chart repository
  kubernetes.core.helm_repository:
    binary_path: "{{ helm_binary }}"
    name: test_helm_repo
    repo_url: "{{ chart_test_repo }}"
  register: repository

- name: Assert that test_helm_repo repository is added
  ansible.builtin.assert:
    that:
      - repository is changed

- name: Check idempotency
  kubernetes.core.helm_repository:
    binary_path: "{{ helm_binary }}"
    name: test_helm_repo
    repo_url: "{{ chart_test_repo }}"
  register: repository

- name: Assert idempotency
  ansible.builtin.assert:
    that:
      - repository is not changed

- name: Failed to add repository with the same name
  kubernetes.core.helm_repository:
    binary_path: "{{ helm_binary }}"
    name: test_helm_repo
    repo_url: "https://other-charts.url"
  register: repository_errors
  failed_when: repository_errors is successful

- name: Assert that adding repository with the same name failed
  ansible.builtin.assert:
    that:
      - repository_errors is failed

- name: Succesfully add repository with the same name when forcing
  kubernetes.core.helm_repository:
    binary_path: "{{ helm_binary }}"
    name: test_helm_repo
    repo_url: "{{ chart_test_repo }}"
    force: true
  register: repository

- name: Assert that test_helm_repo repository is changed
  ansible.builtin.assert:
    that:
      - repository is changed

- name: Remove test_helm_repo chart repository
  kubernetes.core.helm_repository:
    binary_path: "{{ helm_binary }}"
    name: test_helm_repo
    state: absent
  register: repository

- name: Assert that test_helm_repo repository is removed
  ansible.builtin.assert:
    that:
      - repository is changed

- name: Check idempotency after remove
  kubernetes.core.helm_repository:
    binary_path: "{{ helm_binary }}"
    name: test_helm_repo
    state: absent
  register: repository

- name: Assert idempotency
  ansible.builtin.assert:
    that:
      - repository is not changed
